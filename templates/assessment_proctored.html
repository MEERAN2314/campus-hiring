{% extends "base.html" %}

{% block title %}Assessment - HireWave{% endblock %}

{% block extra_css %}
<style>
body {
    overflow: hidden;
}

.proctoring-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #1e40af, #2563eb);
    color: white;
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 1000;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.proctoring-status {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #10b981;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.warning-count {
    background: #f59e0b;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-weight: bold;
}

.timer {
    font-size: 1.2rem;
    font-weight: bold;
    font-family: 'Courier New', monospace;
}

.assessment-container {
    margin-top: 60px;
    height: calc(100vh - 60px);
    overflow-y: auto;
    padding: 2rem;
}

.warning-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 2000;
    justify-content: center;
    align-items: center;
}

.warning-modal.active {
    display: flex;
}

.warning-content {
    background: white;
    padding: 3rem;
    border-radius: 20px;
    max-width: 600px;
    text-align: center;
    animation: shake 0.5s;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

.warning-content h2 {
    color: #ef4444;
    font-size: 2rem;
    margin-bottom: 1rem;
}

.countdown {
    font-size: 4rem;
    font-weight: bold;
    color: #ef4444;
    margin: 2rem 0;
    font-family: 'Courier New', monospace;
}

.question-card {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
}

.question-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e2e8f0;
}

.question-type {
    background: #2563eb;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
}

.question-points {
    color: #10b981;
    font-weight: bold;
}

.mcq-options {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin: 2rem 0;
}

.mcq-option {
    display: flex;
    align-items: center;
    padding: 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s;
}

.mcq-option:hover {
    border-color: #2563eb;
    background: #f0f9ff;
}

.mcq-option input[type="radio"] {
    margin-right: 1rem;
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.coding-editor textarea,
.text-answer textarea {
    width: 100%;
    min-height: 300px;
    padding: 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    resize: vertical;
}

.question-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 2rem;
    gap: 1rem;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: #e2e8f0;
    border-radius: 4px;
    margin-bottom: 2rem;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #2563eb, #10b981);
    transition: width 0.3s;
}
</style>
{% endblock %}

{% block content %}
<!-- Proctoring Bar -->
<div class="proctoring-bar">
    <div class="proctoring-status">
        <div class="status-indicator">
            <div class="status-dot"></div>
            <span>Proctored</span>
        </div>
        <div class="warning-count" id="warningDisplay">
            ‚ö†Ô∏è Warnings: <span id="warningCount">0</span>/2
        </div>
    </div>
    <div class="timer" id="timer">60:00</div>
</div>

<!-- Warning Modal -->
<div class="warning-modal" id="warningModal">
    <div class="warning-content">
        <h2 id="warningTitle">‚ö†Ô∏è WARNING!</h2>
        <p id="warningMessage">You switched tabs! This is not allowed.</p>
        <div class="countdown" id="warningCountdown">10</div>
        <p><strong>Return to the assessment immediately!</strong></p>
        <p id="warningConsequence"></p>
    </div>
</div>

<!-- Assessment Content -->
<div class="assessment-container">
    <div id="assessmentContent">
        <div class="loading">Loading assessment...</div>
    </div>
</div>

<script>
const applicationId = "{{ application_id }}";
let assessment = null;
let currentQuestionIndex = 0;
let answers = [];
let startTime = Date.now();
let warningCount = 0;
let isDisqualified = false;
let warningTimeout = null;
let countdownInterval = null;
let timerInterval = null;

// Check consent
const consent = localStorage.getItem(`assessment_consent_${applicationId}`);
if (!consent) {
    window.location.href = `/assessment/${applicationId}`;
}

// Proctoring: Detect tab switching
let tabSwitchDetected = false;

document.addEventListener('visibilitychange', function() {
    if (document.hidden && !isDisqualified) {
        handleTabSwitch();
    }
});

window.addEventListener('blur', function() {
    if (!isDisqualified && !document.hidden) {
        handleTabSwitch();
    }
});

function handleTabSwitch() {
    if (tabSwitchDetected) return; // Prevent multiple triggers
    tabSwitchDetected = true;
    
    warningCount++;
    document.getElementById('warningCount').textContent = warningCount;
    
    if (warningCount >= 3) {
        disqualifyCandidate();
    } else {
        showWarning();
    }
    
    setTimeout(() => {
        tabSwitchDetected = false;
    }, 1000);
}

function showWarning() {
    const modal = document.getElementById('warningModal');
    const title = document.getElementById('warningTitle');
    const message = document.getElementById('warningMessage');
    const consequence = document.getElementById('warningConsequence');
    
    if (warningCount === 1) {
        title.textContent = '‚ö†Ô∏è FIRST WARNING!';
        message.textContent = 'You switched tabs or left the assessment window!';
        consequence.innerHTML = '<strong style="color: #f59e0b;">You have 1 more warning left. Third violation = DISQUALIFICATION!</strong>';
    } else if (warningCount === 2) {
        title.textContent = 'üö® FINAL WARNING!';
        message.textContent = 'This is your LAST warning!';
        consequence.innerHTML = '<strong style="color: #ef4444;">One more violation and you will be DISQUALIFIED!</strong>';
    }
    
    modal.classList.add('active');
    
    // Countdown
    let countdown = 10;
    document.getElementById('warningCountdown').textContent = countdown;
    
    countdownInterval = setInterval(() => {
        countdown--;
        document.getElementById('warningCountdown').textContent = countdown;
        
        if (countdown <= 0) {
            clearInterval(countdownInterval);
            modal.classList.remove('active');
        }
    }, 1000);
    
    // Auto-close after 10 seconds
    warningTimeout = setTimeout(() => {
        modal.classList.remove('active');
    }, 10000);
}

function disqualifyCandidate() {
    isDisqualified = true;
    clearInterval(timerInterval);
    
    const modal = document.getElementById('warningModal');
    const title = document.getElementById('warningTitle');
    const message = document.getElementById('warningMessage');
    const countdown = document.getElementById('warningCountdown');
    const consequence = document.getElementById('warningConsequence');
    
    title.textContent = '‚ùå DISQUALIFIED!';
    message.textContent = 'You have been disqualified from this assessment.';
    countdown.textContent = '‚úñ';
    consequence.innerHTML = '<strong style="color: #ef4444;">You violated the rules 3 times. Your assessment has been automatically submitted and you are not eligible for this position.</strong>';
    
    modal.classList.add('active');
    
    // Auto-submit and redirect
    setTimeout(async () => {
        await submitAssessment(true); // Force submit with disqualification flag
        alert('You have been disqualified due to multiple rule violations.');
        window.location.href = '/dashboard';
    }, 5000);
}

// Timer
function startTimer(duration) {
    let timeLeft = duration;
    
    timerInterval = setInterval(() => {
        timeLeft--;
        
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        document.getElementById('timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            alert('Time is up! Submitting assessment...');
            submitAssessment(true);
        }
    }, 1000);
}

// Load assessment
async function loadAssessment() {
    const token = localStorage.getItem('token');
    
    try {
        const appResponse = await fetch(`/api/applications/${applicationId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const application = await appResponse.json();
        
        const assessmentResponse = await fetch(`/api/assessments/job/${application.job_id}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        assessment = await assessmentResponse.json();
        
        await fetch(`/api/submissions/start/${applicationId}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        answers = assessment.questions.map(q => ({
            question_id: q.question_id,
            question_type: q.type,
            time_spent_seconds: 0
        }));
        
        startTimer(assessment.config.duration_minutes * 60);
        displayQuestion();
        
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to load assessment');
        window.location.href = '/dashboard';
    }
}

function displayQuestion() {
    const question = assessment.questions[currentQuestionIndex];
    const progress = ((currentQuestionIndex + 1) / assessment.questions.length) * 100;
    
    let html = `
        <div class="progress-bar">
            <div class="progress-fill" style="width: ${progress}%"></div>
        </div>
        
        <h2>${assessment.title}</h2>
        <p>Question ${currentQuestionIndex + 1} of ${assessment.questions.length}</p>
        
        <div class="question-card">
            <div class="question-header">
                <span class="question-type">${question.type.toUpperCase()}</span>
                <span class="question-points">${question.points} points</span>
            </div>
            
            <h3>${question.question_text}</h3>
    `;
    
    if (question.type === 'mcq') {
        html += '<div class="mcq-options">';
        question.options.forEach(opt => {
            const checked = answers[currentQuestionIndex].selected_option_id === opt.option_id ? 'checked' : '';
            html += `
                <label class="mcq-option">
                    <input type="radio" name="answer" value="${opt.option_id}" ${checked}>
                    <span>${opt.text}</span>
                </label>
            `;
        });
        html += '</div>';
    } else if (question.type === 'coding') {
        const code = answers[currentQuestionIndex].code || question.starter_code || '';
        html += `
            <div class="coding-editor">
                <textarea id="codeEditor" placeholder="Write your code here...">${code}</textarea>
            </div>
        `;
    } else {
        const text = answers[currentQuestionIndex].text_answer || '';
        html += `
            <div class="text-answer">
                <textarea id="textAnswer" placeholder="Write your answer here..." rows="10">${text}</textarea>
            </div>
        `;
    }
    
    html += `
            <div class="question-actions">
                ${currentQuestionIndex > 0 ? '<button onclick="previousQuestion()" class="btn btn-outline">‚Üê Previous</button>' : '<div></div>'}
                ${currentQuestionIndex < assessment.questions.length - 1 ? 
                    '<button onclick="nextQuestion()" class="btn btn-primary">Next ‚Üí</button>' :
                    '<button onclick="confirmSubmit()" class="btn btn-primary">Submit Assessment</button>'
                }
            </div>
        </div>
    `;
    
    document.getElementById('assessmentContent').innerHTML = html;
}

function saveCurrentAnswer() {
    const question = assessment.questions[currentQuestionIndex];
    const answer = answers[currentQuestionIndex];
    
    if (question.type === 'mcq') {
        const selected = document.querySelector('input[name="answer"]:checked');
        if (selected) answer.selected_option_id = selected.value;
    } else if (question.type === 'coding') {
        answer.code = document.getElementById('codeEditor').value;
        answer.language = question.language || 'python';
    } else {
        answer.text_answer = document.getElementById('textAnswer').value;
    }
}

function nextQuestion() {
    saveCurrentAnswer();
    currentQuestionIndex++;
    displayQuestion();
}

function previousQuestion() {
    saveCurrentAnswer();
    currentQuestionIndex--;
    displayQuestion();
}

function confirmSubmit() {
    if (confirm('Are you sure you want to submit? You cannot change answers after submission.')) {
        submitAssessment(false);
    }
}

async function submitAssessment(autoSubmit = false) {
    saveCurrentAnswer();
    
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user'));
    
    const submissionData = {
        application_id: applicationId,
        assessment_id: assessment._id || assessment.id,
        candidate_id: user._id || user.id,
        answers: answers,
        warning_count: warningCount,
        disqualified: isDisqualified
    };
    
    try {
        await fetch('/api/submissions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(submissionData)
        });
        
        localStorage.removeItem(`assessment_consent_${applicationId}`);
        localStorage.removeItem(`assessment_start_time_${applicationId}`);
        
        if (!autoSubmit) {
            alert('Assessment submitted successfully!');
        }
        window.location.href = '/dashboard';
        
    } catch (error) {
        console.error('Error:', error);
        window.location.href = '/dashboard';
    }
}

// Prevent right-click
document.addEventListener('contextmenu', e => e.preventDefault());

// Prevent certain keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Prevent F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
    if (e.keyCode === 123 || 
        (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) ||
        (e.ctrlKey && e.keyCode === 85)) {
        e.preventDefault();
        return false;
    }
});

// Start assessment
loadAssessment();
</script>
{% endblock %}
