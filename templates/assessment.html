{% extends "base.html" %}

{% block title %}Assessment - Campus Hiring Platform{% endblock %}

{% block content %}
<section class="assessment-section">
    <div class="container">
        <div id="assessmentContent">
            <div class="loading">Loading assessment...</div>
        </div>
    </div>
</section>

<script>
const applicationId = "{{ application_id }}";
let assessment = null;
let currentQuestionIndex = 0;
let answers = [];
let startTime = Date.now();

async function loadAssessment() {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/login';
        return;
    }
    
    try {
        // Get application
        const appResponse = await fetch(`/api/applications/${applicationId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!appResponse.ok) {
            throw new Error('Application not found');
        }
        
        const application = await appResponse.json();
        
        // Get assessment
        const assessmentResponse = await fetch(`/api/assessments/job/${application.job_id}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!assessmentResponse.ok) {
            throw new Error('Assessment not found');
        }
        
        assessment = await assessmentResponse.json();
        
        // Start assessment
        await fetch(`/api/submissions/start/${applicationId}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        // Initialize answers array
        answers = assessment.questions.map(q => ({
            question_id: q.question_id,
            question_type: q.type,
            time_spent_seconds: 0
        }));
        
        displayQuestion();
        
    } catch (error) {
        console.error('Error loading assessment:', error);
        document.getElementById('assessmentContent').innerHTML = `
            <div class="error-state">
                <h2>Assessment Not Available</h2>
                <p>This job doesn't have an assessment yet. The recruiter needs to create one first.</p>
                <p>Please check back later or contact the recruiter.</p>
                <a href="/dashboard" class="btn btn-primary">Back to Dashboard</a>
            </div>
        `;
    }
}

function displayQuestion() {
    const question = assessment.questions[currentQuestionIndex];
    const container = document.getElementById('assessmentContent');
    
    let questionHTML = `
        <div class="assessment-header">
            <h2>${assessment.title}</h2>
            <div class="assessment-progress">
                Question ${currentQuestionIndex + 1} of ${assessment.questions.length}
            </div>
        </div>
        
        <div class="question-card">
            <div class="question-header">
                <span class="question-type">${question.type}</span>
                <span class="question-points">${question.points} points</span>
            </div>
            
            <h3>${question.question_text}</h3>
    `;
    
    if (question.type === 'mcq') {
        questionHTML += `
            <div class="mcq-options">
                ${question.options.map(opt => `
                    <label class="mcq-option">
                        <input type="radio" name="answer" value="${opt.option_id}">
                        <span>${opt.text}</span>
                    </label>
                `).join('')}
            </div>
        `;
    } else if (question.type === 'coding') {
        questionHTML += `
            <div class="coding-editor">
                <textarea id="codeEditor" placeholder="Write your code here...">${question.starter_code || ''}</textarea>
            </div>
        `;
    } else {
        questionHTML += `
            <div class="text-answer">
                <textarea id="textAnswer" placeholder="Write your answer here..." rows="8"></textarea>
            </div>
        `;
    }
    
    questionHTML += `
            <div class="question-actions">
                ${currentQuestionIndex > 0 ? '<button onclick="previousQuestion()" class="btn btn-outline">Previous</button>' : ''}
                ${currentQuestionIndex < assessment.questions.length - 1 ? 
                    '<button onclick="nextQuestion()" class="btn btn-primary">Next</button>' :
                    '<button onclick="submitAssessment()" class="btn btn-primary">Submit Assessment</button>'
                }
            </div>
        </div>
    `;
    
    container.innerHTML = questionHTML;
}

function saveCurrentAnswer() {
    const question = assessment.questions[currentQuestionIndex];
    const answer = answers[currentQuestionIndex];
    
    if (question.type === 'mcq') {
        const selected = document.querySelector('input[name="answer"]:checked');
        if (selected) {
            answer.selected_option_id = selected.value;
        }
    } else if (question.type === 'coding') {
        answer.code = document.getElementById('codeEditor').value;
        answer.language = question.language || 'python';
    } else {
        answer.text_answer = document.getElementById('textAnswer').value;
    }
}

function nextQuestion() {
    saveCurrentAnswer();
    currentQuestionIndex++;
    displayQuestion();
}

function previousQuestion() {
    saveCurrentAnswer();
    currentQuestionIndex--;
    displayQuestion();
}

async function submitAssessment() {
    if (!confirm('Are you sure you want to submit? You cannot change answers after submission.')) {
        return;
    }
    
    saveCurrentAnswer();
    
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user'));
    const totalTime = Math.floor((Date.now() - startTime) / 1000);
    
    const submissionData = {
        application_id: applicationId,
        assessment_id: assessment._id || assessment.id,
        candidate_id: user._id || user.id,
        answers: answers
    };
    
    console.log('Submitting assessment:', submissionData);
    
    // Show loading
    const submitBtn = document.querySelector('button[onclick="submitAssessment()"]');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
    }
    
    try {
        const response = await fetch('/api/submissions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(submissionData)
        });
        
        console.log('Submission response status:', response.status);
        
        // If status is 201 (Created), it's successful even if JSON parsing fails
        if (response.status === 201 || response.ok) {
            alert('Assessment submitted successfully! Results will be available shortly.');
            window.location.href = '/dashboard';
            return;
        }
        
        // Try to get error details
        try {
            const data = await response.json();
            console.error('Failed to submit:', data);
            alert(`Failed to submit assessment: ${data.detail || 'Unknown error'}`);
        } catch (e) {
            alert('Failed to submit assessment. Please try again.');
        }
        
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Assessment';
        }
        
    } catch (error) {
        console.error('Error submitting assessment:', error);
        
        // Check if submission actually succeeded by checking dashboard
        setTimeout(() => {
            window.location.href = '/dashboard';
        }, 1000);
    }
}

loadAssessment();
</script>
{% endblock %}
